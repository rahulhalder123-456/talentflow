
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    // These functions make the rules easier to read and maintain.

    // Is the user signed in?
    function isAuth() {
      return request.auth != null;
    }

    // Does the incoming request's user ID match the provided userId?
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // Is the user an admin? Checks if their UID is in the admin list.
    // This requires the /config/admins document to be readable.
    function isAdmin() {
      return isAuth() && get(/databases/$(database)/documents/config/admins).data.uids.hasAny([request.auth.uid]);
    }

    // --- Collection Rules ---

    // User Profiles (`users/{userId}`)
    // - Users can read and write to their own profile.
    // - Admins can read any user's profile (to see names, etc.).
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId);
    }

    // Projects (`projects/{projectId}`)
    // - Users can create projects for themselves.
    // - Users can read/update their own projects.
    // - Admins can read/update any project.
    match /projects/{projectId} {
      allow read, update: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;

      // Time Entries (`projects/{projectId}/timeEntries/{entryId}`)
      // - Only admins can manage time entries for a project.
      match /timeEntries/{entryId} {
          allow read, write: if isAdmin();
      }
    }

    // Reviews (`reviews/{reviewId}`)
    // - Reviews are public to read (for testimonials).
    // - Users can create reviews for projects they own.
    // - Admins can manage all reviews.
    match /reviews/{reviewId} {
        allow read: if true;
        allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAdmin();
    }

    // Featured Work (`featuredProjects/{projectId}`)
    // - Featured projects are public to read (for the showcase).
    // - Only admins can manage the showcase.
    match /featuredProjects/{projectId} {
      allow read: if true;
      allow write: if isAdmin(); // create, update, delete
    }
    
    // Support Chats (`chats/{chatId}`)
    // - A user can access their own support chat.
    // - Admins can access all support chats.
    match /chats/{chatId} {
      allow read, write: if (isAuth() && chatId == 'support_' + request.auth.uid) || isAdmin();

      // Messages (`chats/{chatId}/messages/{messageId}`)
      // - Same permissions as the parent chat room.
      match /messages/{messageId} {
        allow read, write: if (isAuth() && chatId == 'support_' + request.auth.uid) || isAdmin();
      }
    }
    
    // Admin Configuration (`config/admins`)
    // - Any signed-in user can read this document to check their own admin status.
    // - ONLY an existing admin can update the list of admins.
    match /config/admins {
        allow get: if isAuth();
        allow update: if isAdmin();
    }
  }
}
