rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is an admin.
    // It reads the list of admin UIDs from the 'config/admins' document.
    function isAdmin() {
      // Important: This function relies on the `config/admins` document being readable by authenticated users.
      return request.auth.uid in get(/databases/$(database)/documents/config/admins).data.uids;
    }

    // USER PROFILES (`users/{userId}`)
    // - Anyone can create their own user profile.
    // - Users can only read and update their own profile.
    // - Admins can read and list all user profiles.
    match /users/{userId} {
      allow list: if isAdmin();
      allow read: if request.auth.uid == userId || isAdmin();
      allow create, update: if request.auth.uid == userId;
    }
    
    // ADMIN CONFIG (`config/admins`)
    // - Any authenticated user can read the admin config to see who is an admin.
    // - Only an existing admin can change who is on the admin list. This prevents a circular dependency.
    match /config/admins {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }

    // PROJECTS (`projects/{projectId}`)
    // - Logged-in users can create projects.
    // - The project owner or an admin can read, update, or delete a project.
    match /projects/{projectId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth.uid == resource.data.userId || isAdmin();

      // Time Entries (`projects/{projectId}/timeEntries/{entryId}`)
      // - Only admins can create, read, update, or delete time entries.
      match /timeEntries/{entryId} {
          allow read, write: if isAdmin();
      }
    }

    // CHATS (`chats/{chatId}`)
    // The chatId is expected to be `support_<userId>`.
    // - A user can access their own support chat.
    // - An admin can access any support chat.
    match /chats/{chatId} {
        allow read, write: if request.auth.uid == chatId.split('_')[1] || isAdmin();

        // Chat Messages (`chats/{chatId}/messages/{messageId}`)
        // - A user can read/write messages in their own support chat.
        // - An admin can read/write messages in any support chat.
        match /messages/{messageId} {
            allow read, write: if request.auth.uid == chatId.split('_')[1] || isAdmin();
        }
    }
    
    // FEATURED PROJECTS (`featuredProjects/{projectId}`)
    // - Only admins can manage featured projects.
    match /featuredProjects/{projectId} {
        allow read, write: if isAdmin();
    }
    
    // REVIEWS (`reviews/{reviewId}`)
    // - Logged-in users can create reviews.
    // - Anyone can read reviews (for the testimonials section).
    // - Admins can delete reviews.
    match /reviews/{reviewId} {
        allow read;
        allow create: if request.auth.uid == request.resource.data.userId;
        allow delete: if isAdmin();
    }
    
    // PAYMENT METHODS (subcollection under users)
    // - Users can only manage their own payment methods.
    match /users/{userId}/paymentMethods/{methodId} {
        allow read, write, delete: if request.auth.uid == userId;
    }
  }
}
